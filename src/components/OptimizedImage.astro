---
interface Props {
  src: string;
  alt: string;
  width?: number;
  height?: number;
  className?: string;
  loading?: 'lazy' | 'eager';
  fetchpriority?: 'high' | 'low' | 'auto';
  sizes?: string;
  objectFit?: 'cover' | 'contain' | 'fill' | 'none' | 'scale-down';
}

const {
  src,
  alt,
  width,
  height,
  className = '',
  loading = 'lazy',
  fetchpriority = 'auto',
  sizes = '(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw',
  objectFit = 'cover'
} = Astro.props;

// Detectar si es imagen LCP (generalmente la primera imagen del hero)
const isLCP = loading === 'eager' && fetchpriority === 'high';

// Generar rutas WebP
const getWebPPath = (originalPath: string, size?: number) => {
  const ext = originalPath.match(/\.(jpg|jpeg|png|webp)$/i)?.[0] || '';
  const basePath = originalPath.replace(/\.(jpg|jpeg|png|webp)$/i, '');
  const sizeSuffix = size ? `-${size}w` : '';
  return `${basePath}${sizeSuffix}.webp`;
};

// Generar srcset para WebP
const sizes_for_srcset = [400, 800, 1200, 1600];
const webpSrcset = sizes_for_srcset
  .map((size) => {
    const webpPath = getWebPPath(src, size);
    return `${encodeURI(webpPath)} ${size}w`;
  })
  .filter(Boolean)
  .join(', ');

// Fallback srcset para formatos originales
const fallbackSrcset = sizes_for_srcset
  .map((size) => {
    return `${encodeURI(src)} ${size}w`;
  })
  .filter(Boolean)
  .join(', ');

// Aspect ratio para evitar CLS
const aspectRatio = width && height ? `${width} / ${height}` : undefined;
const aspectRatioStyle = aspectRatio ? `aspect-ratio: ${aspectRatio};` : '';
---

<picture>
  <!-- WebP con srcset -->
  {webpSrcset && (
    <source
      srcset={webpSrcset}
      sizes={sizes}
      type="image/webp"
    />
  )}
  
  <!-- Fallback con srcset -->
  {fallbackSrcset && (
    <source
      srcset={fallbackSrcset}
      sizes={sizes}
      type={src.match(/\.(jpg|jpeg)$/i) ? 'image/jpeg' : 'image/png'}
    />
  )}
  
  <!-- Imagen fallback -->
  <img
    src={src}
    alt={alt}
    width={width}
    height={height}
    loading={loading}
    fetchpriority={fetchpriority}
    decoding={isLCP ? 'sync' : 'async'}
    class={className}
    style={`
      ${aspectRatioStyle}
      object-fit: ${objectFit};
      ${width ? `max-width: ${width}px;` : ''}
      ${height ? `max-height: ${height}px;` : ''}
    `}
    sizes={sizes}
  />
</picture>

