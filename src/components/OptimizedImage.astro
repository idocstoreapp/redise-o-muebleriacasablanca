---
interface Props {
  src: string;
  alt: string;
  width?: number;
  height?: number;
  className?: string;
  loading?: 'lazy' | 'eager';
  fetchpriority?: 'high' | 'low' | 'auto';
  sizes?: string;
  objectFit?: 'cover' | 'contain' | 'fill' | 'none' | 'scale-down';
  type?: 'hero' | 'content' | 'thumbnail' | 'logo'; // Tipo de imagen para determinar tamaños
}

const {
  src,
  alt,
  width,
  height,
  className = '',
  loading = 'lazy',
  fetchpriority = 'auto',
  sizes,
  objectFit = 'cover',
  type
} = Astro.props;

// Detectar si es imagen LCP (generalmente la primera imagen del hero)
const isLCP = loading === 'eager' && fetchpriority === 'high';

// Determinar sizes attribute si no se proporciona
const sizesAttribute = sizes || (
  type === 'hero' ? '100vw' :
  type === 'logo' || type === 'thumbnail' ? '(max-width: 768px) 150px, 150px' :
  '(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw'
);

// Generar ruta WebP simple (sin tamaño específico)
const getWebPPath = (originalPath: string) => {
  const ext = originalPath.match(/\.(jpg|jpeg|png|webp)$/i)?.[0] || '';
  const basePath = originalPath.replace(/\.(jpg|jpeg|png|webp)$/i, '');
  return `${basePath}.webp`;
};

const webpPath = getWebPPath(src);

// Aspect ratio para evitar CLS
const aspectRatio = width && height ? `${width} / ${height}` : undefined;
const aspectRatioStyle = aspectRatio ? `aspect-ratio: ${aspectRatio};` : '';
---

<picture>
  <!-- WebP simple - Se intentará cargar, pero si no existe usará fallback -->
  <source
    srcset={webpPath}
    type="image/webp"
  />
  
  <!-- Imagen fallback - SIEMPRE se muestra si WebP falla -->
  <img
    src={src}
    alt={alt}
    width={width}
    height={height}
    loading={loading}
    fetchpriority={fetchpriority}
    decoding={isLCP ? 'sync' : 'async'}
    class={className}
    style={`
      ${aspectRatioStyle}
      object-fit: ${objectFit};
      ${width ? `max-width: ${width}px;` : ''}
      ${height ? `max-height: ${height}px;` : ''}
    `}
    sizes={sizesAttribute}
  />
</picture>

